import express from "express";
import cors from "cors";
import fetch from "node-fetch";
import bcrypt from "bcrypt";
import jwt from "jsonwebtoken";

const app = express();
app.use(cors());
app.use(express.json());

const API_KEY = "AIzaSyBEAYwyrHKYuEJeYqDDK3MpRw3V24DWFm0"; // Google API kulcs

const users = [];

const auth = (req,res,next)=>{
  const token = req.headers["authorization"];
  if(!token) return res.status(401).json({error:"Token missing"});
  try{
    const decoded = jwt.verify(token,"secretkey123");
    req.user = decoded;
    next();
  }catch(e){ res.status(401).json({error:"Invalid token"});}
};

// Regisztráció
app.post("/api/register", async (req,res)=>{
  const {username,email,password,phone} = req.body;
  if(!username||!email||!password) return res.status(400).json({error:"All fields required"});
  if(users.find(u=>u.email===email)) return res.status(400).json({error:"Email exists"});
  const hash = await bcrypt.hash(password,10);
  users.push({username,email,password:hash,phone});
  res.json({success:true});
});

// Login
app.post("/api/login", async (req,res)=>{
  const {email,password} = req.body;
  const user = users.find(u=>u.email===email);
  if(!user) return res.status(400).json({error:"User not found"});
  const match = await bcrypt.compare(password,user.password);
  if(!match) return res.status(400).json({error:"Wrong password"});
  const token = jwt.sign({email:user.email,username:user.username},"secretkey123",{expiresIn:"1h"});
  res.json({token});
});

// Directions API
app.get("/api/directions", async (req,res)=>{
  const {origin,destination} = req.query;
  if(!origin||!destination) return res.status(400).json({error:"Origin & destination required"});
  try{
    const response = await fetch(`https://maps.googleapis.com/maps/api/directions/json?origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&alternatives=true&key=${API_KEY}`);
    const data = await response.json();
    if(data.status !== "OK" || !data.routes.length) return res.json({error:`No route found between ${origin} and ${destination}`});
    res.json(data);
  }catch(err){ res.status(500).json({error:err.message});}
});

const PORT = process.env.PORT||3000;
app.listen(PORT,()=>console.log(`Server running on port ${PORT}`));

import React, { useState } from "react";

const languages = {
  hu: { title:"EuroFreight Pro", login:"Bejelentkezés", register:"Regisztráció", calculate:"Számítás" },
  en: { title:"EuroFreight Pro", login:"Login", register:"Register", calculate:"Calculate" },
  de: { title:"EuroFreight Pro", login:"Login", register:"Registrierung", calculate:"Berechnen" }
};

const currencies = { EUR:"€", HUF:"Ft", GBP:"£" };

export default function App() {
  const [token,setToken] = useState<string|null>(null);
  const [showLogin,setShowLogin] = useState(true);
  const [stops,setStops] = useState(["Budapest, Hungary","Stuttgart, Germany"]);
  const [language,setLanguage]=useState<"hu"|"en"|"de">("hu");
  const [currency,setCurrency]=useState<"EUR"|"HUF"|"GBP">("HUF");
  const [results,setResults]=useState<any[]>([]);

  const addStop=()=>setStops([...stops,""]);
  const updateStop=(i:number,val:string)=>{ const arr=[...stops]; arr[i]=val; setStops(arr);}
  const removeStop=(i:number)=>setStops(stops.filter((_,idx)=>idx!==i));

  const calculateTrip=async()=>{
    if(!token){ alert("Jelentkezz be!"); return; }
    let totalDistance=0,totalFuel=0,totalAdBlue=0,totalVehicle=0,totalDriver=0;
    const fuelPrice=1.8,adbluePer100km=0.8,adbluePrice=1.5,vehicleWear=0.2,driverHourly=15,hoursPer100km=2;

    for(let i=0;i<stops.length-1;i++){
      const origin=stops[i], destination=stops[i+1];
      const res = await fetch(`/api/directions?origin=${origin}&destination=${destination}`);
      const data = await res.json();
      if(data.error){ alert(data.error); continue; }
      const r = data.routes[0];
      const distanceKm = r.legs.reduce((acc:any,l:any)=>acc+l.distance.value/1000,0);
      totalDistance+=distanceKm;
      totalFuel+=distanceKm*fuelPrice;
      totalAdBlue+=(distanceKm*adbluePer100km/100)*adbluePrice;
      totalVehicle+=distanceKm*vehicleWear;
      totalDriver+=driverHourly*hoursPer100km*(distanceKm/100);
    }

    setResults([{totalDistance,totalFuel,totalAdBlue,totalVehicle,totalDriver,totalCost:totalFuel+totalAdBlue+totalVehicle+totalDriver}]);
  };

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col items-center p-6 font-sans">
      <h1 className="text-3xl font-bold mb-6">{languages[language].title}</h1>

      {/* Nyelv & Valuta */}
      <div className="flex gap-4 mb-4">
        <select value={language} onChange={e=>setLanguage(e.target.value as any)} className="border rounded px-2 py-1">
          <option value="hu">Magyar</option>
          <option value="en">English</option>
          <option value="de">Deutsch</option>
        </select>
        <select value={currency} onChange={e=>setCurrency(e.target.value as any)} className="border rounded px-2 py-1">
          <option value="EUR">€ EUR</option>
          <option value="HUF">Ft HUF</option>
          <option value="GBP">£ GBP</option>
        </select>
      </div>

      {/* Városok */}
      <div className="bg-white rounded shadow p-4 w-full max-w-lg mb-4">
        {stops.map((stop,i)=>(
          <div key={i} className="flex gap-2 mb-2">
            <input className="border rounded px-2 py-1 flex-1" value={stop} onChange={e=>updateStop(i,e.target.value)} placeholder={`Város #${i+1}`}/>
            {i>0 && <button className="bg-red-500 text-white px-2 rounded" onClick={()=>removeStop(i)}>X</button>}
          </div>
        ))}
        <button className="bg-blue-600 text-white px-4 py-2 rounded mr-2" onClick={addStop}>Új város</button>
        <button className="bg-green-600 text-white px-4 py-2 rounded" onClick={calculateTrip}>{languages[language].calculate}</button>
      </div>

      {/* Eredmények */}
      {results.length>0 && results.map((r,idx)=>(
        <div key={idx} className="bg-white rounded shadow p-4 w-full max-w-lg mb-4">
          <div>Távolság: {r.totalDistance.toFixed(2)} km</div>
          <div>Üzemanyag: {r.totalFuel.toFixed(2)} {currencies[currency]}</div>
          <div>AdBlue: {r.totalAdBlue.toFixed(2)} {currencies[currency]}</div>
          <div>Autó kopás: {r.totalVehicle.toFixed(2)} {currencies[currency]}</div>
          <div>Sofőr: {r.totalDriver.toFixed(2)} {currencies[currency]}</div>
          <div>Teljes költség: {r.totalCost.toFixed(2)} {currencies[currency]}</div>
        </div>
      ))}
    </div>
  );
}